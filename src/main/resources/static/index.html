<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый Центр | Управление личными финансами</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter var', 'ui-sans-serif', 'system-ui'],
                    },
                }
            }
        }
    </script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar {
            transition: all 0.3s ease;
        }

        .dashboard-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .transaction-item:hover {
            background-color: rgba(241, 245, 249, 0.5);
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: flex;
        }

        .error {
            display: none;
        }

        .error.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="sidebar bg-white w-64 border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center">
                    <i data-feather="dollar-sign" class="text-white"></i>
                </div>
                <span class="text-xl font-semibold">Финансовый Центр</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-4">
            <nav>
                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Основное</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 bg-primary-50 text-primary-600 rounded-lg">
                        <i data-feather="home" class="w-5 h-5"></i>
                        <span>Главная</span>
                    </a>
                </div>

                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Операции</p>
                    <a href="transactions.html" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="credit-card" class="w-5 h-5"></i>
                        <span>Транзакции</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="repeat" class="w-5 h-5"></i>
                        <span>Переводы</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="calendar" class="w-5 h-5"></i>
                        <span>Платежи</span>
                    </a>
                </div>

                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Аналитика</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="pie-chart" class="w-5 h-5"></i>
                        <span>Бюджет</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="trending-up" class="w-5 h-5"></i>
                        <span>Отчеты</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="bar-chart-2" class="w-5 h-5"></i>
                        <span>Анализ</span>
                    </a>
                </div>

                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Инвестиции</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="dollar-sign" class="w-5 h-5"></i>
                        <span>Портфель</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="activity" class="w-5 h-5"></i>
                        <span>Рынки</span>
                    </a>
                </div>

                <div class="px-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Настройки</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="settings" class="w-5 h-5"></i>
                        <span>Аккаунт</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="help-circle" class="w-5 h-5"></i>
                        <span>Помощь</span>
                    </a>
                </div>
            </nav>
        </div>

        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                    <i data-feather="user" class="text-gray-600"></i>
                </div>
                <div>
                    <p class="font-medium" id="user-name">Загрузка...</p>
                    <p class="text-sm text-gray-500">Premium</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="flex-1 overflow-auto">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 py-4 px-6 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button class="text-gray-500 hover:text-gray-700">
                    <i data-feather="menu" class="w-6 h-6"></i>
                </button>
                <h1 class="text-xl font-semibold">Главная</h1>
            </div>

            <div class="flex items-center space-x-4">
                <div id="loading" class="loading">
                    <div class="flex items-center space-x-2 text-primary-600">
                        <i data-feather="loader" class="w-4 h-4 animate-spin"></i>
                        <span class="text-sm">Загрузка...</span>
                    </div>
                </div>
                <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full" onclick="refreshData()">
                    <i data-feather="refresh-cw" class="w-5 h-5"></i>
                </button>
                <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full">
                    <i data-feather="bell" class="w-5 h-5"></i>
                </button>
                <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full">
                    <i data-feather="search" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Error Message -->
        <div id="error" class="error mx-6 mt-4 p-4 bg-danger-50 border border-danger-200 rounded-lg">
            <div class="flex items-center space-x-2 text-danger-700">
                <i data-feather="alert-circle" class="w-5 h-5"></i>
                <span id="error-message"></span>
            </div>
        </div>

        <!-- Dashboard content -->
        <main class="p-6">
            <!-- Welcome and quick actions -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold" id="welcome-message">Добро пожаловать!</h2>
                        <p class="text-gray-500" id="current-date">Загрузка даты...</p>
                    </div>
                    <div class="flex space-x-3">
                        <button class="flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition">
                            <i data-feather="plus" class="w-4 h-4"></i>
                            <span>Добавить операцию</span>
                        </button>
                        <button class="flex items-center space-x-2 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition">
                            <i data-feather="upload" class="w-4 h-4"></i>
                            <span>Импорт</span>
                        </button>
                    </div>
                </div>

                <!-- Financial overview cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="financial-cards">
                    <!-- Динамически загружаемые карточки -->
                </div>

                <!-- Charts and transactions -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Cash flow chart -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold">Движение денежных средств</h3>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 text-sm bg-primary-50 text-primary-600 rounded-lg">Месяц</button>
                                <button class="px-3 py-1 text-sm text-gray-500 hover:bg-gray-100 rounded-lg">Квартал</button>
                                <button class="px-3 py-1 text-sm text-gray-500 hover:bg-gray-100 rounded-lg">Год</button>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>

                    <!-- Expense distribution -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-semibold mb-6">Распределение расходов</h3>
                        <div class="h-64">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent transactions and budgets -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Recent transactions -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold">Последние операции</h3>
                            <a href="#" class="text-primary-600 hover:text-primary-800 text-sm font-medium">Смотреть все</a>
                        </div>

                        <div class="space-y-4" id="recent-transactions">
                            <!-- Динамически загружаемые транзакции -->
                        </div>
                    </div>

                    <!-- Accounts overview -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold">Мои счета</h3>
                            <a href="#" class="text-primary-600 hover:text-primary-800 text-sm font-medium">Управлять</a>
                        </div>

                        <div class="space-y-4" id="accounts-overview">
                            <!-- Динамически загружаемые счета -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8080/api';
    const currentUserId = 1;

    // Форматирование денег
    function formatMoney(amount) {
        if (!amount && amount !== 0) return '0 ₽';
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 0
        }).format(amount);
    }

    // Форматирование даты
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) return 'Сегодня';
        if (diffDays === 2) return 'Вчера';
        if (diffDays <= 7) return `${diffDays - 1} дней назад`;

        return date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long'
        });
    }

    // Обновление текущей даты
    function updateCurrentDate() {
        const now = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('current-date').textContent = `Сегодня: ${now.toLocaleDateString('ru-RU', options)}`;
    }

    // Показать/скрыть загрузку
    function showLoading(show) {
        const loadingElement = document.getElementById('loading');
        if (loadingElement) {
            loadingElement.classList.toggle('show', show);
        }
    }

    // Показать ошибку
    function showError(message) {
        const errorElement = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        if (errorElement && errorMessage) {
            errorMessage.textContent = message;
            errorElement.classList.add('show');
        }
    }

    // Скрыть ошибку
    function hideError() {
        const errorElement = document.getElementById('error');
        if (errorElement) {
            errorElement.classList.remove('show');
        }
    }

    // Загрузка данных дашборда
    async function loadDashboard() {
        try {
            showLoading(true);
            hideError();

            const response = await fetch(`${API_BASE_URL}/dashboard/${currentUserId}`);
            if (!response.ok) throw new Error('Ошибка сервера: ' + response.status);

            const data = await response.json();
            renderDashboard(data);

        } catch (error) {
            showError('Ошибка загрузки дашборда: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    // Отрисовка дашборда
    function renderDashboard(data) {
        // Обновляем имя пользователя
        document.getElementById('user-name').textContent = data.userName || 'Пользователь';
        document.getElementById('welcome-message').textContent = `Добро пожаловать, ${data.userName || 'Гость'}!`;

        // Финансовые карточки
        renderFinancialCards(data);

        // Последние транзакции
        renderRecentTransactions(data.recentTransactionDtoList);

        // Обзор счетов
        renderAccountsOverview(data.walletBalanceDtoList);

        // Графики
        renderCharts(data);
    }

    // Отрисовка финансовых карточек
    function renderFinancialCards(data) {
        const container = document.getElementById('financial-cards');
        if (!container) return;

        container.innerHTML = `
            <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-500 font-medium">Общий баланс</h3>
                    <i data-feather="dollar-sign" class="text-primary-500"></i>
                </div>
                <p class="text-2xl font-bold">${formatMoney(data.totalBalance)}</p>
                <p class="text-sm text-success-500 flex items-center mt-1">
                    <i data-feather="trending-up" class="w-4 h-4 mr-1"></i>
                    <span>+12,340 ₽ (4.5%)</span>
                </p>
            </div>

            <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-500 font-medium">Доходы</h3>
                    <i data-feather="arrow-down-right" class="text-success-500"></i>
                </div>
                <p class="text-2xl font-bold">${formatMoney(data.totalIncomes)}</p>
                <p class="text-sm text-gray-500 mt-1">за текущий месяц</p>
            </div>

            <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-500 font-medium">Расходы</h3>
                    <i data-feather="arrow-up-right" class="text-danger-500"></i>
                </div>
                <p class="text-2xl font-bold">${formatMoney(data.totalExpenses)}</p>
                <p class="text-sm text-danger-500 flex items-center mt-1">
                    <i data-feather="alert-circle" class="w-4 h-4 mr-1"></i>
                    <span>+5,200 ₽ (7.1%)</span>
                </p>
            </div>

            <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-500 font-medium">Сбережения</h3>
                    <i data-feather="piggy-bank" class="text-primary-500"></i>
                </div>
                <p class="text-2xl font-bold">${formatMoney(data.saving)}</p>
                <p class="text-sm text-gray-500 mt-1">до цели: 43,700 ₽</p>
            </div>
        `;

        feather.replace();
    }

    // Отрисовка последних транзакций
    function renderRecentTransactions(transactions) {
        const container = document.getElementById('recent-transactions');
        if (!container) return;

        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет операций</p>';
            return;
        }

        const transactionsHtml = transactions.slice(0, 6).map(transaction => {
            const isIncome = transaction.type === 'INCOME';
            const icon = isIncome ? 'dollar-sign' : 'shopping-bag';
            const colorClass = isIncome ? 'text-success-500' : 'text-danger-500';
            const bgColorClass = isIncome ? 'bg-success-50' : 'bg-danger-50';
            const amountSign = isIncome ? '+' : '-';

            return `
                <div class="transaction-item flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full ${bgColorClass} flex items-center justify-center">
                            <i data-feather="${icon}" class="${colorClass}"></i>
                        </div>
                        <div>
                            <p class="font-medium">${transaction.name}</p>
                            <p class="text-sm text-gray-500">${isIncome ? 'Доход' : 'Расход'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-medium ${colorClass}">${amountSign}${formatMoney(Math.abs(transaction.amount))}</p>
                        <p class="text-sm text-gray-500">${formatDate(transaction.dateTime)}</p>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = transactionsHtml;
        feather.replace();
    }

    // Отрисовка обзора счетов
    function renderAccountsOverview(wallets) {
        const container = document.getElementById('accounts-overview');
        if (!container) return;

        if (!wallets || wallets.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет счетов</p>';
            return;
        }

        const walletsHtml = wallets.slice(0, 4).map(wallet => {
            const isNegative = wallet.balance < 0;
            const colorClass = isNegative ? 'text-danger-500' : 'text-gray-900';
            const bgColorClass = isNegative ? 'bg-danger-50' : 'bg-primary-50';
            const iconColorClass = isNegative ? 'text-danger-500' : 'text-primary-500';

            return `
                <div class="transaction-item flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full ${bgColorClass} flex items-center justify-center">
                            <i data-feather="credit-card" class="${iconColorClass}"></i>
                        </div>
                        <div>
                            <p class="font-medium">${wallet.name}</p>
                            <p class="text-sm text-gray-500">Счет</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-medium ${colorClass}">${formatMoney(wallet.balance)}</p>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = walletsHtml;
        feather.replace();
    }

    // Отрисовка графиков
    function renderCharts(data) {
        // График распределения расходов
        renderExpenseChart(data.expenseDtoList);

        // График движения денег (пока статический)
        renderCashFlowChart();
    }

    function renderExpenseChart(expenses) {
        const ctx = document.getElementById('expenseChart');
        if (!ctx || !expenses) return;

        const categories = expenses.map(e => e.name);
        const amounts = expenses.map(e => e.amount);

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categories,
                datasets: [{
                    data: amounts,
                    backgroundColor: [
                        '#ef4444',
                        '#0ea5e9',
                        '#f59e0b',
                        '#8b5cf6',
                        '#22c55e',
                        '#64748b'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${formatMoney(value)} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderCashFlowChart() {
        const ctx = document.getElementById('cashFlowChart');
        if (!ctx) return;

        // Статические данные для демонстрации
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['1 окт', '5 окт', '10 окт', '15 окт', '20 окт', '25 окт', '30 окт'],
                datasets: [
                    {
                        label: 'Доходы',
                        data: [25000, 28000, 30000, 32000, 35000, 37000, 40000],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: 'Расходы',
                        data: [18000, 20000, 22000, 25000, 23000, 26000, 28000],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('ru-RU') + ' ₽';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('ru-RU') + ' ₽';
                            }
                        }
                    }
                }
            }
        });
    }

    // Обновление данных
    function refreshData() {
        loadDashboard();
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        AOS.init();
        updateCurrentDate();
        loadDashboard();
    });
</script>
</body>
</html>