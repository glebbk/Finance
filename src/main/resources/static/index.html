<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Финансовый Центр | Управление личными финансами</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                    },
                    fontFamily: {
                        sans: ['Inter var', 'ui-sans-serif', 'system-ui'],
                    },
                }
            }
        }
    </script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .sidebar {
            transition: all 0.3s ease;
        }

        .dashboard-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .transaction-item:hover {
            background-color: rgba(241, 245, 249, 0.5);
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: flex;
        }

        .error {
            display: none;
        }

        .error.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
<!-- Auth Prompt Modal -->
<div id="auth-prompt" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl w-96">
        <div class="text-center mb-6">
            <div class="w-16 h-16 rounded-full bg-primary-100 flex items-center justify-center mx-auto mb-4">
                <i data-feather="lock" class="text-primary-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900">Вход в систему</h3>
            <p class="text-gray-600 mt-2">Введите ваши учетные данные</p>
        </div>

        <form id="login-form">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="auth-email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="your@email.com" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Пароль</label>
                    <input type="password" id="auth-password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Ваш пароль" required>
                </div>
            </div>

            <div class="mt-6 flex space-x-3">
                <button type="submit" class="flex-1 bg-primary-500 text-white py-3 rounded-lg hover:bg-primary-600 transition font-medium">
                    Войти
                </button>
                <button type="button" id="cancel-auth-btn" class="flex-1 border border-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-50 transition font-medium">
                    Отмена
                </button>
            </div>
        </form>
    </div>
</div>

<div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="sidebar bg-white w-64 border-r border-gray-200 flex flex-col">
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-primary-500 flex items-center justify-center">
                    <i data-feather="dollar-sign" class="text-white"></i>
                </div>
                <span class="text-xl font-semibold">Финансовый Центр</span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-4">
            <nav>
                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Основное</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 bg-primary-50 text-primary-600 rounded-lg">
                        <i data-feather="home" class="w-5 h-5"></i>
                        <span>Главная</span>
                    </a>
                </div>

                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Операции</p>
                    <a href="transactions.html" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="credit-card" class="w-5 h-5"></i>
                        <span>Транзакции</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="repeat" class="w-5 h-5"></i>
                        <span>Переводы</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="calendar" class="w-5 h-5"></i>
                        <span>Платежи</span>
                    </a>
                </div>

                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Аналитика</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="pie-chart" class="w-5 h-5"></i>
                        <span>Бюджет</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="trending-up" class="w-5 h-5"></i>
                        <span>Отчеты</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="bar-chart-2" class="w-5 h-5"></i>
                        <span>Анализ</span>
                    </a>
                </div>

                <div class="px-4 mb-6">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Инвестиции</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="dollar-sign" class="w-5 h-5"></i>
                        <span>Портфель</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="activity" class="w-5 h-5"></i>
                        <span>Рынки</span>
                    </a>
                </div>

                <div class="px-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Настройки</p>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg mb-1">
                        <i data-feather="settings" class="w-5 h-5"></i>
                        <span>Аккаунт</span>
                    </a>
                    <a href="#" class="flex items-center space-x-3 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                        <i data-feather="help-circle" class="w-5 h-5"></i>
                        <span>Помощь</span>
                    </a>
                </div>
            </nav>
        </div>

        <div class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                    <i data-feather="user" class="text-gray-600"></i>
                </div>
                <div>
                    <p class="font-medium" id="user-name">Гость</p>
                    <p class="text-sm text-gray-500" id="user-email">Войдите в систему</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full flex items-center space-x-2 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                <i data-feather="log-out" class="w-4 h-4"></i>
                <span>Выйти</span>
            </button>
        </div>
    </div>

    <!-- Main content -->
    <div class="flex-1 overflow-auto">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 py-4 px-6 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button class="text-gray-500 hover:text-gray-700">
                    <i data-feather="menu" class="w-6 h-6"></i>
                </button>
                <h1 class="text-xl font-semibold">Главная</h1>
            </div>

            <div class="flex items-center space-x-4">
                <div id="auth-status" class="flex items-center space-x-2 text-sm text-gray-600">
                    <i data-feather="user" class="w-4 h-4"></i>
                    <span id="auth-status-text">Не авторизован</span>
                </div>
                <div id="loading" class="loading">
                    <div class="flex items-center space-x-2 text-primary-600">
                        <i data-feather="loader" class="w-4 h-4 animate-spin"></i>
                        <span class="text-sm">Загрузка...</span>
                    </div>
                </div>
                <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full" onclick="refreshData()">
                    <i data-feather="refresh-cw" class="w-5 h-5"></i>
                </button>
                <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full">
                    <i data-feather="bell" class="w-5 h-5"></i>
                </button>
                <button class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full">
                    <i data-feather="search" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <!-- Error Message -->
        <div id="error" class="error mx-6 mt-4 p-4 bg-danger-50 border border-danger-200 rounded-lg">
            <div class="flex items-center space-x-2 text-danger-700">
                <i data-feather="alert-circle" class="w-5 h-5"></i>
                <span id="error-message"></span>
            </div>
        </div>

        <!-- Dashboard content -->
        <main class="p-6">
            <!-- Welcome and quick actions -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold" id="welcome-message">Добро пожаловать в Финансовый Центр!</h2>
                        <p class="text-gray-500" id="current-date">Загрузка даты...</p>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="showAuthPrompt()" class="flex items-center space-x-2 bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-600 transition">
                            <i data-feather="log-in" class="w-4 h-4"></i>
                            <span>Войти в систему</span>
                        </button>
                        <button class="flex items-center space-x-2 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition">
                            <i data-feather="help-circle" class="w-4 h-4"></i>
                            <span>Помощь</span>
                        </button>
                    </div>
                </div>

                <!-- Financial overview cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="financial-cards">
                    <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100 text-center">
                        <div class="w-12 h-12 rounded-full bg-primary-100 flex items-center justify-center mx-auto mb-4">
                            <i data-feather="log-in" class="text-primary-500"></i>
                        </div>
                        <h3 class="text-gray-500 font-medium mb-2">Требуется авторизация</h3>
                        <p class="text-sm text-gray-500">Войдите в систему чтобы увидеть ваши финансовые данные</p>
                        <button onclick="showAuthPrompt()" class="mt-4 text-primary-600 hover:text-primary-800 text-sm font-medium">
                            Войти сейчас →
                        </button>
                    </div>
                </div>

                <!-- Charts and transactions -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Cash flow chart -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold">Движение денежных средств</h3>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 text-sm bg-primary-50 text-primary-600 rounded-lg">Месяц</button>
                                <button class="px-3 py-1 text-sm text-gray-500 hover:bg-gray-100 rounded-lg">Квартал</button>
                                <button class="px-3 py-1 text-sm text-gray-500 hover:bg-gray-100 rounded-lg">Год</button>
                            </div>
                        </div>
                        <div class="h-64">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>

                    <!-- Expense distribution -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-semibold mb-6">Распределение расходов</h3>
                        <div class="h-64">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent transactions and budgets -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Recent transactions -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold">Последние операции</h3>
                            <a href="#" class="text-primary-600 hover:text-primary-800 text-sm font-medium">Смотреть все</a>
                        </div>

                        <div class="space-y-4" id="recent-transactions">
                            <div class="text-center py-8 text-gray-500">
                                <i data-feather="credit-card" class="w-8 h-8 mx-auto mb-2"></i>
                                <p>Войдите для просмотра операций</p>
                            </div>
                        </div>
                    </div>

                    <!-- Accounts overview -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="font-semibold">Мои счета</h3>
                            <a href="#" class="text-primary-600 hover:text-primary-800 text-sm font-medium">Управлять</a>
                        </div>

                        <div class="space-y-4" id="accounts-overview">
                            <div class="text-center py-8 text-gray-500">
                                <i data-feather="credit-card" class="w-8 h-8 mx-auto mb-2"></i>
                                <p>Нет доступных счетов</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8080/api';

    // Глобальные переменные для хранения экземпляров графиков
    let expenseChartInstance = null;
    let cashFlowChartInstance = null;

    // Форматирование денег
    function formatMoney(amount) {
        if (!amount && amount !== 0) return '0 ₽';
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 0
        }).format(amount);
    }

    // Форматирование даты
    function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) return 'Сегодня';
        if (diffDays === 2) return 'Вчера';
        if (diffDays <= 7) return `${diffDays - 1} дней назад`;

        return date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long'
        });
    }

    // Обновление текущей даты
    function updateCurrentDate() {
        const now = new Date();
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('current-date').textContent = `Сегодня: ${now.toLocaleDateString('ru-RU', options)}`;
    }

    // Показать/скрыть загрузку
    function showLoading(show) {
        const loadingElement = document.getElementById('loading');
        if (loadingElement) {
            loadingElement.classList.toggle('show', show);
        }
    }

    // Показать ошибку
    function showError(message) {
        const errorElement = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        if (errorElement && errorMessage) {
            errorMessage.textContent = message;
            errorElement.classList.add('show');
        }
    }

    // Скрыть ошибку
    function hideError() {
        const errorElement = document.getElementById('error');
        if (errorElement) {
            errorElement.classList.remove('show');
        }
    }

    // Показать окно авторизации
    function showAuthPrompt() {
        console.log('showAuthPrompt called');
        const authPrompt = document.getElementById('auth-prompt');
        if (authPrompt) {
            authPrompt.classList.remove('hidden');
            console.log('Auth prompt should be visible now');
        }
    }

    // Скрыть окно авторизации
    function hideAuthPrompt() {
        console.log('hideAuthPrompt called');
        const authPrompt = document.getElementById('auth-prompt');
        if (authPrompt) {
            authPrompt.classList.add('hidden');
            console.log('Auth prompt should be hidden now');
        }
        // Очищаем поля формы
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-password').value = '';
        // Скрываем ошибки
        hideError();
    }

    // Обработчик формы входа
    document.getElementById('login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Login form submitted');
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;

        if (!email || !password) {
            showError('Пожалуйста, заполните все поля');
            return;
        }

        console.log('Saving credentials to localStorage');
        // Сохраняем учетные данные
        localStorage.setItem('username', email);
        localStorage.setItem('password', password);

        updateAuthStatus();

        // Пробуем загрузить данные (функция сама закроет окно при успехе)
        await testAuthAndLoadData();
    });

    // Функция для проверки аутентификации и загрузки данных
    async function testAuthAndLoadData() {
        try {
            console.log('=== START testAuthAndLoadData ===');
            showLoading(true);
            hideError();

            const username = localStorage.getItem('username');
            const password = localStorage.getItem('password');
            console.log('Credentials from localStorage:', { username, password: password ? '***' : 'empty' });

            // Пробуем сделать простой запрос для проверки аутентификации
            console.log('Making test request to financialSummary...');
            const testData = await makeAuthenticatedRequest(`${API_BASE_URL}/dashboard/financialSummary`);
            console.log('✅ Authentication successful, received data:', testData);

            // Если успешно - загружаем все данные
            console.log('Loading financial summary...');
            await loadFinancialSummary();
            console.log('✅ Financial summary loaded');

            console.log('Loading dashboard...');
            await loadDashboard();
            console.log('✅ Dashboard loaded');

            // Скрываем окно авторизации после успешного входа
            console.log('Calling hideAuthPrompt...');
            hideAuthPrompt();
            showError(''); // Очищаем возможные предыдущие ошибки
            console.log('✅ Authentication flow completed successfully');

        } catch (error) {
            console.error('❌ Authentication failed:', error);
            // Если аутентификация не удалась
            localStorage.removeItem('username');
            localStorage.removeItem('password');
            updateAuthStatus();

            if (error.message.includes('401') || error.message.includes('Неверные учетные данные')) {
                showError('Неверный email или пароль');
                showAuthPrompt(); // Показываем окно входа снова
            } else {
                showError('Ошибка авторизации: ' + error.message);
            }
        } finally {
            showLoading(false);
            console.log('=== END testAuthAndLoadData ===');
        }
    }

    // Выход из системы
    function logout() {
        console.log('Logout called');
        // Уничтожаем графики перед выходом
        destroyCharts();
        localStorage.removeItem('username');
        localStorage.removeItem('password');
        updateAuthStatus();
        location.reload(); // Полностью перезагружаем страницу
    }

    // Уничтожение графиков
    function destroyCharts() {
        if (expenseChartInstance) {
            expenseChartInstance.destroy();
            expenseChartInstance = null;
        }
        if (cashFlowChartInstance) {
            cashFlowChartInstance.destroy();
            cashFlowChartInstance = null;
        }
    }

    // Обновление статуса авторизации
    function updateAuthStatus() {
        const username = localStorage.getItem('username');
        const authStatus = document.getElementById('auth-status-text');
        const userEmail = document.getElementById('user-email');
        const userName = document.getElementById('user-name');

        if (username) {
            authStatus.textContent = 'Авторизован';
            userEmail.textContent = username;
            userName.textContent = 'Пользователь';
            document.getElementById('auth-status').classList.remove('text-gray-600');
            document.getElementById('auth-status').classList.add('text-success-600');
        } else {
            authStatus.textContent = 'Не авторизован';
            userEmail.textContent = 'Войдите в систему';
            userName.textContent = 'Гость';
            document.getElementById('auth-status').classList.remove('text-success-600');
            document.getElementById('auth-status').classList.add('text-gray-600');
        }
    }

    // Функция для аутентифицированных запросов
    async function makeAuthenticatedRequest(url, options = {}) {
        const username = localStorage.getItem('username');
        const password = localStorage.getItem('password');

        console.log('Making authenticated request to:', url);

        if (!username || !password) {
            throw new Error('Требуется авторизация');
        }

        const headers = {
            'Authorization': 'Basic ' + btoa(username + ':' + password),
            'Content-Type': 'application/json',
            ...options.headers
        };

        console.log('Sending request with Basic Auth header');
        const response = await fetch(url, { ...options, headers });

        console.log('Response status:', response.status);

        if (response.status === 401) {
            throw new Error('Неверные учетные данные');
        }

        if (!response.ok) {
            throw new Error('Ошибка сервера: ' + response.status);
        }

        const responseData = await response.json();
        console.log('Response data received successfully');
        return responseData;
    }

    // Загрузка финансовой сводки
    async function loadFinancialSummary() {
        try {
            console.log('Loading financial summary from API...');
            const data = await makeAuthenticatedRequest(`${API_BASE_URL}/dashboard/financialSummary`);
            renderFinancialCards(data);
            console.log('Financial summary rendered');
        } catch (error) {
            console.error('Error loading financial summary:', error);
            throw error;
        }
    }

    // Загрузка дашборда
    async function loadDashboard() {
        try {
            console.log('Loading dashboard from API...');
            const data = await makeAuthenticatedRequest(`${API_BASE_URL}/dashboard/dashBoard`);
            renderDashboard(data);
            console.log('Dashboard rendered');
        } catch (error) {
            console.error('Error loading dashboard:', error);
            throw error;
        }
    }

    // Отрисовка финансовых карточек
    // Отрисовка финансовых карточек
    function renderFinancialCards(data) {
        console.log('Rendering financial cards with data:', data);
        const container = document.getElementById('financial-cards');
        if (!container) {
            console.error('Financial cards container not found!');
            return;
        }

        function formatPercent(percent) {
            if (!percent) return '0%';
            const sign = percent >= 0 ? '+' : '';
            return `${sign}${Math.abs(percent)}%`;
        }

        function getChangeStyles(change) {
            if (!change) return { color: 'text-gray-500', icon: 'minus', sign: '' };

            const isPositive = change > 0;
            const color = isPositive ? 'text-success-500' : 'text-danger-500';
            const icon = isPositive ? 'trending-up' : 'trending-down';
            const sign = isPositive ? '+' : '';

            return { color, icon, sign };
        }

        const balanceStyles = getChangeStyles(data.balanceChange);
        const incomeStyles = getChangeStyles(data.incomesChange);
        const expenseStyles = getChangeStyles(data.expensesChange);

        container.innerHTML = `
        <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-500 font-medium">Общий баланс</h3>
                <i data-feather="dollar-sign" class="text-primary-500"></i>
            </div>
            <p class="text-2xl font-bold">${formatMoney(data.totalBalance)}</p>
            <p class="text-sm ${balanceStyles.color} flex items-center mt-1">
                <i data-feather="${balanceStyles.icon}" class="w-4 h-4 mr-1"></i>
                <span>${balanceStyles.sign}${formatMoney(data.balanceChange)} (${formatPercent(data.balanceChangePercent)})</span>
            </p>
        </div>

        <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-500 font-medium">Доходы</h3>
                <i data-feather="arrow-down-right" class="text-success-500"></i>
            </div>
            <p class="text-2xl font-bold">${formatMoney(data.totalIncomes)}</p>
            <p class="text-sm ${incomeStyles.color} flex items-center mt-1">
                <i data-feather="${incomeStyles.icon}" class="w-4 h-4 mr-1"></i>
                <span>${incomeStyles.sign}${formatMoney(data.incomesChange)} (${formatPercent(data.incomesChangePercent)})</span>
            </p>
            <p class="text-xs text-gray-500 mt-1">${data.incomesPeriod || 'за текущий месяц'}</p>
        </div>

        <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-500 font-medium">Расходы</h3>
                <i data-feather="arrow-up-right" class="text-danger-500"></i>
            </div>
            <p class="text-2xl font-bold">${formatMoney(data.totalExpenses)}</p>
            <p class="text-sm ${expenseStyles.color} flex items-center mt-1">
                <i data-feather="${expenseStyles.icon}" class="w-4 h-4 mr-1"></i>
                <span>${expenseStyles.sign}${formatMoney(data.expensesChange)} (${formatPercent(data.expensesChangePercent)})</span>
            </p>
            <p class="text-xs text-gray-500 mt-1">${data.expensesTargetInfo || ''}</p>
        </div>

        <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-500 font-medium">Сбережения</h3>
                <i data-feather="save" class="text-primary-500"></i>
            </div>
            <p class="text-2xl font-bold">${formatMoney(data.saving)}</p>
            <p class="text-sm text-gray-500 mt-1">до цели: ${formatMoney(data.savingTarget)}</p>
            ${data.savingProgress && data.savingProgress !== 0 ?
                `<div class="mt-2 bg-gray-200 rounded-full h-2">
                    <div class="bg-primary-500 h-2 rounded-full" style="width: ${Math.min(100, Math.max(0, data.savingProgress))}%"></div>
                </div>` : ''
            }
        </div>
    `;

        feather.replace();
        console.log('Financial cards rendered successfully');
    }

    // Отрисовка дашборда
    function renderDashboard(data) {
        console.log('Rendering dashboard with data:', data);
        document.getElementById('user-name').textContent = data.userName || 'Пользователь';
        document.getElementById('welcome-message').textContent = `Добро пожаловать, ${data.userName || 'Гость'}!`;

        renderRecentTransactions(data.recentTransactionDtoList);
        renderAccountsOverview(data.walletBalanceDtoList);
        renderCharts(data);
        console.log('Dashboard rendered successfully');
    }

    // Отрисовка последних транзакций
    function renderRecentTransactions(transactions) {
        console.log('Rendering recent transactions:', transactions);
        const container = document.getElementById('recent-transactions');
        if (!container) {
            console.error('Recent transactions container not found!');
            return;
        }

        if (!transactions || transactions.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет операций</p>';
            return;
        }

        const transactionsHtml = transactions.slice(0, 6).map(transaction => {
            const isIncome = transaction.type === 'INCOME';
            const icon = isIncome ? 'dollar-sign' : 'shopping-bag';
            const colorClass = isIncome ? 'text-success-500' : 'text-danger-500';
            const bgColorClass = isIncome ? 'bg-success-50' : 'bg-danger-50';
            const amountSign = isIncome ? '+' : '-';

            return `
                <div class="transaction-item flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full ${bgColorClass} flex items-center justify-center">
                            <i data-feather="${icon}" class="${colorClass}"></i>
                        </div>
                        <div>
                            <p class="font-medium">${transaction.name}</p>
                            <p class="text-sm text-gray-500">${isIncome ? 'Доход' : 'Расход'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-medium ${colorClass}">${amountSign}${formatMoney(Math.abs(transaction.amount))}</p>
                        <p class="text-sm text-gray-500">${formatDate(transaction.dateTime)}</p>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = transactionsHtml;
        feather.replace();
        console.log('Recent transactions rendered successfully');
    }

    // Отрисовка обзора счетов
    function renderAccountsOverview(wallets) {
        console.log('Rendering accounts overview:', wallets);
        const container = document.getElementById('accounts-overview');
        if (!container) {
            console.error('Accounts overview container not found!');
            return;
        }

        if (!wallets || wallets.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center py-4">Нет счетов</p>';
            return;
        }

        const walletsHtml = wallets.slice(0, 4).map(wallet => {
            const isNegative = wallet.balance < 0;
            const colorClass = isNegative ? 'text-danger-500' : 'text-gray-900';
            const bgColorClass = isNegative ? 'bg-danger-50' : 'bg-primary-50';
            const iconColorClass = isNegative ? 'text-danger-500' : 'text-primary-500';

            return `
                <div class="transaction-item flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full ${bgColorClass} flex items-center justify-center">
                            <i data-feather="credit-card" class="${iconColorClass}"></i>
                        </div>
                        <div>
                            <p class="font-medium">${wallet.name}</p>
                            <p class="text-sm text-gray-500">Счет</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-medium ${colorClass}">${formatMoney(wallet.balance)}</p>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = walletsHtml;
        feather.replace();
        console.log('Accounts overview rendered successfully');
    }

    // Отрисовка графиков
    function renderCharts(data) {
        console.log('Rendering charts with data:', data);
        // Уничтожаем старые графики перед созданием новых
        destroyCharts();

        // Создаем новые графики
        initializeEmptyCharts();
        console.log('Charts rendered successfully');
    }

    function initializeEmptyCharts() {
        console.log('Initializing empty charts');
        // Инициализация пустого графика расходов
        const expenseCtx = document.getElementById('expenseChart');
        if (expenseCtx) {
            // Очищаем canvas перед созданием нового графика
            expenseCtx.getContext('2d').clearRect(0, 0, expenseCtx.width, expenseCtx.height);

            expenseChartInstance = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Нет данных'],
                    datasets: [{
                        data: [100],
                        backgroundColor: ['#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    }
                }
            });
        }

        // Инициализация пустого графика денежных потоков
        const cashFlowCtx = document.getElementById('cashFlowChart');
        if (cashFlowCtx) {
            // Очищаем canvas перед созданием нового графика
            cashFlowCtx.getContext('2d').clearRect(0, 0, cashFlowCtx.width, cashFlowCtx.height);

            cashFlowChartInstance = new Chart(cashFlowCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        console.log('Empty charts initialized successfully');
    }

    // Обновление данных
    function refreshData() {
        console.log('Refresh data called');
        const username = localStorage.getItem('username');
        if (username) {
            loadFinancialSummary();
            loadDashboard();
        } else {
            showAuthPrompt();
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded');
        feather.replace();
        AOS.init();
        updateCurrentDate();
        updateAuthStatus();

        // Обработчик для кнопки отмены
        const cancelButton = document.getElementById('cancel-auth-btn');
        if (cancelButton) {
            cancelButton.addEventListener('click', hideAuthPrompt);
        }

        // Обработчик для клика вне модального окна
        const authPrompt = document.getElementById('auth-prompt');
        if (authPrompt) {
            authPrompt.addEventListener('click', function(e) {
                if (e.target === authPrompt) {
                    hideAuthPrompt();
                }
            });
        }

        // Проверяем, есть ли сохраненные учетные данные
        const username = localStorage.getItem('username');
        if (username) {
            console.log('Found saved credentials, auto-login');
            // Автоматически загружаем данные если пользователь уже авторизован
            testAuthAndLoadData();
        } else {
            console.log('No saved credentials, showing auth prompt');
            // Показываем окно входа через небольшую задержку для лучшего UX
            setTimeout(() => {
                showAuthPrompt();
            }, 500);
        }
    });
</script>
</body>
</html>